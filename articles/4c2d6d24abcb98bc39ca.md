---
title: "Azureã§ãƒã‚¤ã‚¯ãƒ©é¯–ã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹"
emoji: "ğŸ³"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["minecraft", "azure", "docker", "ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼2020"]
published: false
---

ã“ã®è¨˜äº‹ã¯[Azureã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼]()ãŠã‚ˆã³[æ„šè€…ã£ã¨Corp.ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼]()ã® 20 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

# ã¯ã˜ã‚ã«

ã©ã†ã‚‚ã€ã«ãƒ¼å…„ã•ã‚“ã§ã™ã€‚
æœ€è¿‘ Azure ã«ãƒãƒã£ã¦ã„ã‚‹ã®ã§ã€ä»Šæ—¥ã¯åˆã‚ã¦ Azure ã«é–¢ã™ã‚‹è¨˜äº‹ã‚’æ›¸ãã¾ã™ã€‚
ãƒ‰ç´ äººãªã®ã§ãŠæ‰‹æŸ”ã‚‰ã‹ã«ãŠé¡˜ã„ã—ã¾ã™ã€‚

## ã“ã®è¨˜äº‹ã§å¾—ã‚‰ã‚Œã‚‹çŸ¥è¦‹ã¨å¯¾è±¡èª­è€…

ã“ã®è¨˜äº‹ã‚’èª­ã‚“ã§å¾—ã‚‰ã‚Œã‚‹çŸ¥è¦‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- Azure Container Instances ã« docker ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
- docker ã‚’ä½¿ã£ã¦ãƒã‚¤ã‚¯ãƒ©é¯–ã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹æ–¹æ³•
- Azure Container Instances ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã™ã‚‹æ–¹æ³•

ä»¥ä¸Šã‚ˆã‚Šã€ã“ã®è¨˜äº‹ã®å¯¾è±¡èª­è€…ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- ãƒã‚¤ã‚¯ãƒ©ã‚’ãƒ—ãƒ¬ã‚¤ã—ãŸã“ã¨ãŒã‚ã‚‹
- Azure ã‚’ä½¿ã£ãŸã“ã¨ãŒã‚ã‚‹ã€ã‚‚ã—ãã¯ã©ã‚“ãªã‚‚ã®ã‹çŸ¥ã£ã¦ã„ã‚‹
- ã¨ã‚Šã‚ãˆãšãƒã‚¤ã‚¯ãƒ©ã‚’ã¿ã‚“ãªã§ã‚„ã‚ŠãŸã„ã‘ã©è‡ªåˆ†ã§ç®¡ç†ã‚‚ã—ãŸã„
- Azure Container Instances ãŒæ°—ã«ãªã‚‹
- Azure ã§ä½•ã‹ã‚„ã£ã¦ã¿ãŸã„

ãã‚‚ãã‚‚è‡ªåˆ†ãŒ Dockerã€Azureã€ãƒã‚¤ã‚¯ãƒ©é¯–ã‚’é‹ç”¨ã™ã‚‹ã“ã¨è‡ªä½“ãŒåˆã‚ã¦ã ã£ãŸã®ã§ã€çµæ§‹åˆå¿ƒè€…å‘ã‘ã«ãªã‚‹ã¯ãšã§ã™ã€‚

## æ¤œè¨¼ç’°å¢ƒ

æ¤œè¨¼ç’°å¢ƒã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚ã¨ã„ã£ã¦ã‚‚ä½œæ¥­ã¯å…¨éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰ã§ã‚„ã‚‹ã®ã§ã‚ã¾ã‚Šé–¢ä¿‚ãªã„ã§ã™ã­ã€‚

|||
|:--:|:--:|
|Azure ã‚µãƒ–ã‚¹ã‚¯|Azure for Student|
|ãƒã‚¤ã‚¯ãƒ©é¯–ç”¨ã‚³ãƒ³ãƒ†ãƒŠ|[itzg/docker-minecraft-server](https://github.com/itzg/docker-minecraft-server)|
|ãƒã‚¤ã‚¯ãƒ©ãƒãƒ¼ã‚¸ãƒ§ãƒ³|`1.16.4`(åŸ·ç­†æ™‚ç‚¹ã® Latest)|

# Azureã§ãƒã‚¤ã‚¯ãƒ©é¯–ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

## æŠ€è¡“æ§‹æˆã‚„ãƒ—ãƒ©ãƒ³

ä»Šå›ã®è¨˜äº‹ã§ã™ãŒã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒãƒ£ãƒ³ãƒãƒ«(é€šç§°ãã‚‰ã§ã¹)ã®[ã“ã®å‹•ç”»](https://www.youtube.com/watch?v=-D9kfLLCZys)ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹å†…å®¹ãŒå…ƒãƒã‚¿ã ã£ãŸã‚Šã—ã¾ã™ã€‚
@[youtube](-D9kfLLCZys)
ã¨ã„ã†ã“ã¨ã§ã¾ãšã¯ã“ã®å‹•ç”»ã«ã¤ã„ã¦å°‘ã—èª¬æ˜ã—ã¾ã™ã€‚

å‹•ç”»ã§ã¯ã€ã‚ŠãŠã•ã‚“ã¨ã„ã†ã¤ã‚ˆã¤ã‚ˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æ–¹ãŒä½œã£ãŸ[ã“ã¡ã‚‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ](https://github.com/rioriost/deploy_minecraft/blob/master/create_minecraft.sh)ã‚’ä½¿ã£ã¦ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã£ã¦ã„ã¾ã—ãŸã€‚
å®Ÿéš›ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‹•ã‹ã›ã°ä»Šå›ç´¹ä»‹ã™ã‚‹å†…å®¹ã¯ã™ã¹ã¦å®Ÿç¾ã§ãã‚‹ã‚ã‘ã§ã™ãŒã€æ­£ç›´ä½•ãŒèµ·ã“ã£ã¦ã‚‹ã®ã‹ã‚ˆãã‚ã‹ã‚‰ãšå®Ÿè¡Œã™ã‚‹ã®ãŒæ€–ã„ã§ã™ã€‚
ã¨ã„ã†ã“ã¨ã§ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ä½œæ¥­æ‰‹é †ã‚’èª­ã¿è§£ãã€Azure Portal ã§æ‰‹ã‚’å‹•ã‹ã—ãªãŒã‚‰ã‚„ã£ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã—ãŸã€‚

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¸»è¦éƒ¨åˆ†ã‚’å¼•ç”¨ã—ã¾ã™ã€‚

```sh: create_minecraft.sh
# ...

echo "Creating Resource Group..."
res=$(az group create -l $ACI_RES_LOC -g $ACI_RES_GRP -o tsv --query "properties.provisioningState")
if [ "$res" != "Succeeded" ]; then
	exit
fi

# Create the storage account with the parameters
echo "Creating Storage Account..."
res=$(az storage account create -g $ACI_RES_GRP -n $ACI_STR_AN -l $ACI_RES_LOC --sku Premium_LRS --kind FileStorage -o tsv --query "provisioningState")
if [ "$res" != "Succeeded" ]; then
	az group delete --yes --no-wait -g $ACI_RES_GRP
	exit
fi

# Create the file share
echo "Creating Storage Share..."
res=$(az storage share create -n $ACI_STR_SH_NAME --account-name $ACI_STR_AN -o tsv --query "created")
if [ "$res" != "true" ]; then
	az group delete --yes --no-wait -g $ACI_RES_GRP
	exit
fi
STORAGE_KEY=$(az storage account keys list -g $ACI_RES_GRP --account-name $ACI_STR_AN --query "[0].value" -o tsv)

# Create the container
echo "Creating Container..."
res=$(az container create --image rioriost/minecraft-server -g $ACI_RES_GRP -n $ACI_CNT_NAME \
	--ip-address Public --ports 25565 25575 \
	--dns-name-label $ACI_CNT_NAME \
	--cpu 2 --memory 8 \
	-e EULA=TRUE ENABLE_RCON=true \
	RCON_PASSWORD=$RCON_PASSWORD \
	--azure-file-volume-account-name $ACI_STR_AN \
	--azure-file-volume-account-key "$STORAGE_KEY" \
	--azure-file-volume-share-name $ACI_STR_SH_NAME \
	--azure-file-volume-mount-path /data/ \
	-o tsv --query "provisioningState")

# ...
```

è‰²ã€…æ›¸ã„ã¦ã‚ã‚Šã¾ã™ãŒã€å¤§é›‘æŠŠã«å‘¼ã‚“ã§ã¿ã‚‹ã¨ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã«ã‚ˆã‚Š
ãƒã‚¤ã‚¯ãƒ©é¯–ã‚’ãƒ›ã‚¹ãƒˆã§ãã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

1. ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
2. Storage Account ã®ä½œæˆ
3. ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ã®ä½œæˆ(è¨­å®š)
4. Container Instances ã®ä½œæˆ

ã¨ã„ã†ã“ã¨ã§ã€ã“ã‚Œã‚‰ã‚’ã‚„ã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚æ§‹æˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
![diagram](https://storage.googleapis.com/zenn-user-upload/4pujmjmki8v555a1y5tp63ijznjd)

## ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ

ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è¨€ã†ã¨ã“ã‚ã®ä¸‹ã®éƒ¨åˆ†ã«å½“ãŸã‚Šã¾ã™ã€‚

```bash
az group create -l $ACI_RES_LOC -g $ACI_RES_GRP -o tsv --query "properties.provisioningState"
```

## Storage Accoutã®ä½œæˆã¨è¨­å®š

ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è¨€ã†ã¨ã“ã‚ã®ä¸‹è¨˜ã®éƒ¨åˆ†ã«è©²å½“ã—ã¾ã™ã€‚

```bash
az storage account create -g $ACI_RES_GRP -n $ACI_STR_AN -l $ACI_RES_LOC --sku Premium_LRS --kind FileStorage -o tsv --query "provisioningState"
```

```bash
az storage share create -n $ACI_STR_SH_NAME --account-name $ACI_STR_AN -o tsv --query "created"
```

## Container Instancesã‚’ä½¿ã£ãŸã‚³ãƒ³ãƒ†ãƒŠã®ãƒ‡ãƒ—ãƒ­ã‚¤

ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¸‹è¨˜éƒ¨åˆ†ã®å‡¦ç†ã‚’ã—ã¦ã„ãã¾ã™ã€‚

```bash
az container create --image rioriost/minecraft-server -g $ACI_RES_GRP -n $ACI_CNT_NAME \
	--ip-address Public --ports 25565 25575 \
	--dns-name-label $ACI_CNT_NAME \
	--cpu 2 --memory 8 \
	-e EULA=TRUE ENABLE_RCON=true \
	RCON_PASSWORD=$RCON_PASSWORD \
	--azure-file-volume-account-name $ACI_STR_AN \
	--azure-file-volume-account-key "$STORAGE_KEY" \
	--azure-file-volume-share-name $ACI_STR_SH_NAME \
	--azure-file-volume-mount-path /data/ \
	-o tsv --query "provisioningState"
```

# ãŠã‚ã‚Šã«

ç´ äººãªã‚Šã«ã€ã²ã¨ã¨ãŠã‚Š Azure Container Instances ã«ãƒã‚¤ã‚¯ãƒ©é¯–ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãƒ›ã‚¹ãƒˆã™ã‚‹ã¾ã§ã‚’ã‚„ã‚Šã¾ã—ãŸã€‚
ACI è‡ªä½“ãŒä¸€æ™‚çš„ãªã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã‚·ãƒŠãƒªã‚ªã‚’æƒ³å®šã•ã‚Œã¦ã„ãã†ãªã‚µãƒ¼ãƒ“ã‚¹ãªã®ã§ã€
ãŒã£ã¤ã‚Šé‹ç”¨ã™ã‚‹ãªã‚‰ Azure VM ä½¿ã£ãŸã»ã†ãŒã‚ˆã•ãã†ã§ã™ã­ã€‚ä¾¡æ ¼ã¨ã‹ã‚‚å¤‰ã‚ã£ã¦ãã‚‹ã‚“ã ã‚ã†ã‹ã€‚

æœ€å¾Œã¾ã§ã”è¦§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
ä½•ã‹ã®ã”å‚è€ƒã«ãªã£ãŸã‚‰å¹¸ã„ã§ã™ã€‚
