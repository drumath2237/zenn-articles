---
title: "WebXR Depth Sensing Moduleã«ã¤ã„ã¦ã®èª¿æŸ»"
emoji: "ğŸ•µï¸â€â™‚ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["webar", "ar", "javascript", "typescript"]
published: false
---

:::message
æœ¬è¨˜äº‹ã¯[WebXR ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼](https://adventar.org/calendars/7401)ã®ï½æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

## TL;DR

## è¨˜äº‹ã®æ¦‚è¦ã¨å¯¾è±¡èª­è€…

æœ¬è¨˜äº‹ã§ã¯ WebXR Depth Sensing Module ã¨ã„ã†ã‚‚ã®ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚
è©³ç´°ã¯å¾Œè¿°ã—ã¾ã™ãŒã€ãƒ–ãƒ©ã‚¦ã‚¶ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ WebAR ã® API ãªã®ã§ WebAR é–‹ç™ºè€…å‘ã‘ã®å†…å®¹ã«ãªã‚Šã¾ã™ã€‚

ã¾ãŸæœ¬è¨˜äº‹ã§ã¯ JavaScriptãƒ»TypeScriptãƒ»Babylon.js ãªã©ã®æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã‚’èª¬æ˜ãªã—ã«å–ã‚Šä¸Šã’ã¾ã™ã®ã§ã€ãã‚Œã‚‰ã®çŸ¥è­˜ãŒã‚ã‚‹ã¨æœ›ã¾ã—ã„ã§ã™ã€‚

## æ¤œè¨¼ç’°å¢ƒ

ç­†è€…ãŒæ¤œè¨¼ã«ç”¨ã„ãŸç’°å¢ƒã‚’æ¬¡ã«ç¤ºã—ã¾ã™ã€‚

| ç’°å¢ƒ          | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã©                |
| :------------ | :---------------------------- |
| é–‹ç™ºæ©Ÿ        | Windows 10 Home               |
| ãƒ‡ãƒãƒƒã‚°æ©Ÿ    | Android 12 Google Pixel 4a 5G |
| Google Chrome | Chrome for Android 106        |
| Node.js       | 16.13.0                       |
| yarn          | 1.22.18                       |
| Vite          | 3.1.0                         |
| TypeScript    | 4                             |
| Babylon.js    | 5.27.0                        |

## ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

WebXR Depth Sensing Module ã‚’ Babylon.js ã§ä½¿ã£ãŸã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ GitHub ã«å…¬é–‹ã—ã¦ãŠã‚Šã¾ã™ã®ã§ã€åˆã‚ã›ã¦ã”è¦§ãã ã•ã„ã€‚

https://github.com/drumath2237/webxr-depth-testbed-babylon

# WebXR Depth Sensing Module ã®æ¦‚è¦

## ã“ã® Module ã¯ã„ã£ãŸã„ä½•ãªã®ã‹

WebXR Depth Sensing Module ã¨ã¯ã€WebXR Device API ã§æä¾›ã•ã‚Œã¦ã„ã‚‹ Module ã®ä¸€ç¨®ã§ã™ã€‚
W3C ã® Working Draft ã«æ¦‚è¦ã‚„ä½¿ã„æ–¹ãªã©ãŒè¨˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://www.w3.org/TR/2022/WD-webxr-depth-sensing-1-20220419/

è‰æ¡ˆã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã¯ä»¥ä¸‹ã§ã™ã€‚

https://github.com/immersive-web/depth-sensing/

## ä½•ãŒã§ãã‚‹ã®ã‹

ã“ã® Module ã¯åå‰ã®é€šã‚Šã€Depthã€ã¤ã¾ã‚Šæ·±åº¦æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã® API ã‚’æä¾›ã—ã¾ã™ã€‚
æ·±åº¦æƒ…å ±ã¨ã¯ WebAR ãƒ‡ãƒã‚¤ã‚¹ã®ã‚«ãƒ¡ãƒ©ç”»è§’ã«ãŠã„ã¦ã€ã€Œã“ã“ã‚‰ã¸ã‚“ã«è¦‹ãˆã¦ã„ã‚‹ç‰©ã¯ã©ã®ãã‚‰ã„ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰é›¢ã‚Œã¦ã„ã‚‹ã®ã‹ã€ã‚’è¡¨ã™ã‚‚ã®ã§ã™ã€‚

ä¾‹ãˆã° iPhone ã«ã¯ LiDAR ã‚»ãƒ³ã‚µãƒ¼ãŒè¼‰ã£ã¦ã„ã‚‹æ©Ÿç¨®ãŒã‚ã‚Šã¾ã™ãŒã€LiDAR ã‚»ãƒ³ã‚µãƒ¼ã‚’ä½¿ã†ã“ã¨ã§å…‰ãŒé£›ã‚“ã§ã„ã‚‹æ™‚é–“ã‹ã‚‰å…‰ãŒåˆ°é”ã—ãŸç‰©ä½“ã¾ã§ã®è·é›¢ã‚’å‰²ã‚Šå‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸ LiDAR ã‚»ãƒ³ã‚µãƒ¼ãŒè¼‰ã£ã¦ã„ãªã„ ARCore ã«å¯¾å¿œã—ãŸ Android ãƒ‡ãƒã‚¤ã‚¹ã‚‚ã€ç”»åƒå‡¦ç†ã«ã‚ˆã£ã¦æ·±åº¦æ¨å®šã‚’ã—ã¦è·é›¢ã‚’æ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚
ä»Šç´¹ä»‹ã—ãŸã‚‚ã®ã¯ã„ãšã‚Œã‚‚ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã® API ã«ã‚ˆã£ã¦å®Ÿç¾å¯èƒ½ã§ã™ãŒã€ã“ã‚Œã‚‰ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã§ã‚‚å®Ÿç¾ã—ãŸã‚‚ã®ãŒ WebXR Depth Sensing Module ã§ã™ã€‚
Depth ç”»åƒã‚’ä½¿ã†ã¨ç‰©ä½“ã®å½¢çŠ¶ã‚’ 3 æ¬¡å…ƒçš„ã«å¾©å…ƒã—ãŸã‚Šã€AR ã‚·ãƒ¼ãƒ³ã§ã‚ªã‚¯ãƒ«ãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å®Ÿç¾ã—ãŸã‚Šã€ç©ºé–“èªè­˜ã®ç²¾åº¦ã‚’å‘ä¸Šã•ã›ãŸã‚Šã§ãã¾ã™ã€‚

![img](https://docs-assets.developer.apple.com/published/e2a121be00/rendered2x-1611871073.png)
_Depth ç”»åƒã®å‚è€ƒï¼ˆå¼•ç”¨ï¼š[Apple Developer](https://developer.apple.com/documentation/arkit/environmental_analysis/displaying_a_point_cloud_using_scene_depth)ï¼‰_

## ã©ã†ã‚„ã£ã¦ä½¿ã†ã®ã‹

ä½¿ã„æ–¹ã‚’çŸ¥ã‚‹ã«ã¯ GitHub ã® explaner ã‚’è¦‹ã‚‹ã®ãŒä¸€ç•ªç°¡å˜ã§ã™ã€‚
åŸºæœ¬çš„ãªä½¿ã„æ–¹ã¨å‹å®šç¾©ãªã©ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚ã‚‚ã£ã¨è©³ã—ãçŸ¥ã‚ŠãŸã„å ´åˆã¯ W3C ã® Working Draft ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

https://github.com/immersive-web/depth-sensing/blob/main/explainer.md

### æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰

explaner ã«æ›¸ã„ã¦ã‚ã‚‹é€šã‚Šã€WebXRSession ã‚’å—ã‘å–ã‚‹éš›ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦ DepthSesning ã®æ©Ÿèƒ½ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã™ã€‚

```js
const session = await navigator.xr.requestSession("immersive-ar", {
  requiredFeatures: ["depth-sensing"],
  depthSensing: {
    usagePreference: ["cpu-optimized", "gpu-optimized"],
    formatPreference: ["luminance-alpha", "float32"],
  },
});
```

ã“ã“ã§ç‰¹å¾´çš„ãªã®ã¯ã€ŒUsageã€ã¨ã€ŒFormatã€ã‚’æŒ‡å®šã§ãã‚‹ç‚¹ã§ã—ã‚‡ã†ã€‚

### Usage ã¨ Format

ã¾ãš Usage ã§ã™ãŒã€æ·±åº¦ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†ç”¨é€”ã‚’æŒ‡å®šã§ãã¾ã™ã€‚å…·ä½“çš„ã«ã¯ CPU ã§å‡¦ç†ã‚’ã™ã‚‹æƒ³å®šãªã®ã‹ã€GPU ã‚’æƒ³å®šã—ã¦ã„ã‚‹ã‹ã§ã™ã€‚æ‰±ã„æ–¹ã®è©³ç´°ã¯å¾Œè¿°ã—ã¾ã™ãŒã€Usage ã«ã‚ˆã£ã¦æ·±åº¦æƒ…å ±ã‚’ã©ã“ã‹ã‚‰å–å¾—ã—ã¦ä½•ãŒè¿”ã£ã¦ãã‚‹ã®ã‹ãŒå¤‰ã‚ã£ã¦ãã¾ã™ã®ã§ã€ç”¨é€”ã«åˆã‚ã›ã¦é©åˆ‡ãªã‚‚ã®ã‚’é¸æŠã—ã¾ã—ã‚‡ã†ã€‚æ¬¡ã® Web IDL ã‚’ã”è¦§ãã ã•ã„ï¼ˆexplaner ã‹ã‚‰å¼•ç”¨ï¼‰ã€‚

```webidl: æ·±åº¦æƒ…å ±ã®å®šç¾©
[SecureContext, Exposed=Window]
interface XRDepthInformation {
  // All methods / attributes are accessible only when the frame
  // that the depth information originated from is active and animated.

  readonly attribute unsigned long width;
  readonly attribute unsigned long height;

  [SameObject] readonly attribute XRRigidTransform normTextureFromNormView;
  readonly attribute float rawValueToMeters;
};

interface XRCPUDepthInformation : XRDepthInformation {
  // Data format is determined by session's depthDataFormat attribute.
  [SameObject] readonly attribute ArrayBuffer data;

  // ãŠãã‚‰ãã“ã“ã®å¼•æ•°ã¯longã˜ã‚ƒãªãã¦floatã ã£ãŸæ°—ãŒã™ã‚‹ï¼ˆexplanerã®ãƒŸã‚¹ï¼Ÿï¼‰
  float getDepthInMeters(unsigned long column, unsigned long row);
};

interface XRWebGLDepthInformation : XRDepthInformation {
  // Opaque texture, its format is determined by session's depthDataFormat attribute.
  [SameObject] readonly attribute WebGLTexture texture;
};
```

ã“ã“ã«ã¯`XRDepthInformation`ã¨ã„ã†å…±é€šã®ãƒ‡ãƒ¼ã‚¿ã‚’å®šç¾©ã—ãŸã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã¨ã€ãã‚Œã‚’ç¶™æ‰¿ã—ãŸ`XRCPUDepthInformation`ã¨`XRWebGLDepthInformation`ãŒã‚ã‚Šã¾ã™ã­ã€‚
åå‰ã‚’è‰¯ãè¦‹ã‚‹ã¨ CPUãƒ»WebGL ã¨ã„ã£ãŸå˜èªãŒå…¥ã£ã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚‹é€šã‚Šã€ã“ã‚Œã‚‰ã¯ãã‚Œãã‚Œ`cpu-optimize`ãƒ¢ãƒ¼ãƒ‰ã¨`gpu-optimize`ãƒ¢ãƒ¼ãƒ‰ã§å—ã‘å–ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™ã€‚
CPU ãƒ¢ãƒ¼ãƒ‰ã§ã¯ ArrayBuffer ã«ã‚ˆã‚‹é…åˆ—ã§æ·±åº¦é…åˆ—ã‚’å–å¾—ã§ãã¾ã™ãŒã€GPU ãƒ¢ãƒ¼ãƒ‰ã§ã¯ WebGLTexture ã¨ã—ã¦æ·±åº¦ç”»åƒã‚’å–å¾—ã§ãã¾ã™ã€‚

æ¬¡ã« Format ã§ã™ãŒã€ã“ã¡ã‚‰ã¯`luminance-alpha`ã‚‚ã—ãã¯`float32`ã‚’æŒ‡å®šã§ãã¾ã™ã€‚
`luminance-alpha`ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã€æ·±åº¦ãƒãƒƒãƒ•ã‚¡ï¼ˆæ·±åº¦é…åˆ—ã‚„æ·±åº¦ç”»åƒã®ãƒ‡ãƒ¼ã‚¿ï¼‰ã¯ uint16 å‹ï¼ˆshort å‹ï¼‰ã€ã¤ã¾ã‚Š 16bit æ•´æ•°å€¤ã¨ã—ã¦è¿”ã£ã¦ãã¾ã™ã€‚`float32`ã‚’æŒ‡å®šã—ãŸå ´åˆã€æ·±åº¦ãƒãƒƒãƒ•ã‚¡ã¯ float å‹ã§ 4 ãƒã‚¤ãƒˆã®æµ®å‹•å°æ•°ã§è¿”ã£ã¦ãã¾ã™ã€‚è©³ã—ã„ä»•æ§˜ã¯ Working Draft ã®è¡¨ãŒã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã®ã§å¼•ç”¨ã—ã¾ã™ã€‚

![img](/images/depth-sensing-module/depthformat-table.png)
_Format ã®é•ã„ã‚’èª¬æ˜ã—ãŸè¡¨ï¼ˆå¼•ç”¨ï¼š[Working Draft](https://www.w3.org/TR/2022/WD-webxr-depth-sensing-1-20220419/#usage-and-formats)ï¼‰_

### æ·±åº¦æƒ…å ±ã‚’å–å¾—ã™ã‚‹

<!-- CPUãƒ»GPUãƒ¢ãƒ¼ãƒ‰ãã‚Œãã‚Œã§å–å¾—æ–¹æ³•ã®é•ã„ã‚’èª¬æ˜ã™ã‚‹ -->

æ·±åº¦æƒ…å ±ã®å–å¾—æ–¹æ³•ã¯ã€CPU ãƒ¢ãƒ¼ãƒ‰ã‹ GPU ãƒ¢ãƒ¼ãƒ‰ã‹ã§å¤‰ã‚ã£ã¦ãã¾ã™ã€‚
ã¾ãš CPU ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æ·±åº¦æƒ…å ±ã¯ XRFrame ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚

```js: DepthInfoã®å–å¾—ï¼ˆexplanerã‹ã‚‰å¼•ç”¨ï¼‰
const view = ...;  // Obtained from a viewer pose.
const depthInfo = frame.getDepthInformation(view);

if(depthInfo == null) {
  ... // Handle the case where current frame does not carry depth information.
}

// Obtain the depth at (x, y) normalized view coordinates:
const depthInMeters = depthInfo.getDepthInMeters(x, y);
```

ä¸Šã®ä¾‹ã§ã¯`getDepthInMeters`ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦ç”»é¢ã® UV ã‹ã‚‰è·é›¢ã‚’ 1 ã¤å–å¾—ã—ã¦ã„ã¾ã™ã­ã€‚
CPU ãƒ¢ãƒ¼ãƒ‰ã§ã¯æ¬¡ã®ã‚ˆã†ã«æ·±åº¦é…åˆ—ã‚‚å—ã‘å–ã‚Œã¾ã™ã€‚`depthInfo.data`ã¯`ArrayBuffer`ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹ã®ã§ã€é©å½“ãª TypedArray ã«è§£é‡ˆã•ã›ã¾ã™ã€‚

```js: æ·±åº¦é…åˆ—ã®å–å¾—ï¼ˆluminance-alphaã®å ´åˆï¼‰
const uint16Data = new Uint16Array(depthInfo.data);

const index = c + r * depthInfo.width;
const depthInMetres = uint16Data[index] * depthInfo.rawValueToMeters;
```

```js: æ·±åº¦é…åˆ—ã®å–å¾—ï¼ˆfloat32ã®å ´åˆï¼‰
const float32Data = new Float32Array(depthInfo.data);

const index = c + r * depthInfo.width;
const depthInMetres = float32Data[index] * depthInfo.rawValueToMeters;
```

GPU ãƒ¢ãƒ¼ãƒ‰ãªå ´åˆã¯ WebGLBindings ã‹ã‚‰å–å¾—ã§ãã¾ã™ï¼ˆexplaner ã‹ã‚‰å¼•ç”¨ï¼‰ã€‚

```js: DepthIndoã®å–å¾—ï¼ˆGPUãƒ¢ãƒ¼ãƒ‰ï¼‰
const view = ...;  // Obtained from a viewer pose.
const xrWebGLBinding = ...; // XRWebGLBinding created for the current session and GL context

const depthInfo = xrWebGLBinding.getDepthInformation(view);
```

æ·±åº¦ç”»åƒã¯`depthInfo.texture`ã§å–å¾—å‡ºæ¥ã‚‹ã®ã§ã‚·ã‚§ãƒ¼ãƒ€ãªã©ã§å‡¦ç†ã‚’ã—ã¾ã™ãŒã€
å„ãƒ”ã‚¯ã‚»ãƒ«ã¯`luminance-alpha`ã ã¨ uint16ã€`float32`ã ã¨ float å‹ã§æ‰±ã†ç‚¹ã ã‘æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

## å‹•ä½œè¦ä»¶ãªã©

https://immersiveweb.dev/#supporttable

# Babylon.js ã§ã®æ‰±ã„æ–¹ï¼ˆ2022 å¹´ 12 æœˆæ™‚ç‚¹ï¼‰

## `scene.createDefaultXRExperienceAsync`ã§ã¯ä½¿ãˆãªã„

## `enterXRAsync`ã‚’å‘¼ã³å‡ºã—ã¦è§£æ±º

# ãŠã‚ã‚Šã«

## å‚è€ƒæ–‡çŒ®

https://www.w3.org/TR/2022/WD-webxr-depth-sensing-1-20220419/

https://github.com/immersive-web/depth-sensing/

https://zenn.dev/drumath2237/scraps/9df1e32f7de989
